---
apiVersion: kubevirt.io/v1alpha3
kind: VirtualMachineInstance
metadata:
  name: 'uperf-client-{{item.status.interfaces[0].ipAddress}}-{{ trunc_uuid }}'
  namespace: '{{ operator_namespace }}'
  labels:
    app: uperf-bench-client-{{ trunc_uuid }}
spec:
  domain:
    devices:
      disks:
      - disk:
          bus: virtio
        name: containerdisk
      - disk:
          bus: virtio
        name: cloudinitdisk
      - disk: {}
        name: app-config-disk
        # set serial
        serial: CVLY623300HK240D
      - disk: {}
        name: run-config-disk
        # set serial
        serial: CVLY623300HK250D
    machine:
      type: ""
    resources:
      requests:
        memory: 1024M
  terminationGracePeriodSeconds: 0
  volumes:
  - name: containerdisk
    containerDisk:
      image: quay.io/rht_perf_ci/uperf:vm
  - cloudInitNoCloud:
      userData: |-
        #cloud-config
        password: fedora
        chpasswd: { expire: False }
        bootcmd:
          # mount the ConfigMap
          - "mkdir /tmp/uperf-test"
          - "mount /dev/$(lsblk --nodeps -no name,serial | grep CVLY623300HK240D | cut -f1 -d' ') /tmp/uperf-test"
          # mount the ConfigMap
          - "mkdir /tmp/uperf_script"
          - "mount /dev/$(lsblk --nodeps -no name,serial | grep CVLY623300HK250D | cut -f1 -d' ') /tmp/uperf_script"
        runcmd:
          - bash /tmp/uperf_script/run_script.sh
    name: cloudinitdisk
  - configMap:
      name: uperf-test-{{ trunc_uuid }}
    name: app-config-disk
  - configMap:
      name: uperf-run-script-{{item.status.interfaces[0].ipAddress}}-{{ trunc_uuid }}
    name: run-config-disk
status: {}
